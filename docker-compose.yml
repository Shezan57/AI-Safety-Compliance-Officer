# ===================================================================
# Docker Compose Configuration
# Purpose: Local development and testing of microservices
# Services: Detection Service, Agent Service, LocalStack (AWS mock)
# ===================================================================

version: '3.8'

services:
  # ============================================
  # Detection Service (Computer Vision)
  # ============================================
  # OPTION 1: Single Detection Service
  # Uncomment this for single camera setup
  # ============================================
  detection-service:
    build:
      context: .
      dockerfile: Dockerfile.detection
    container_name: safety-detection
    environment:
      - VIDEO_SOURCE=${VIDEO_SOURCE:-0}
      - CAMERA_ID=${CAMERA_ID:-main_camera}
      - SITE_LOCATION=${SITE_LOCATION:-Zone 3, Building B}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - SQS_QUEUE_URL=${SQS_QUEUE_URL}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-safety-violations}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - DB_CONNECTION_STRING=${DB_CONNECTION_STRING}
      - FRAME_SKIP=${FRAME_SKIP:-30}
      - CONFIDENCE_THRESHOLD=${CONFIDENCE_THRESHOLD:-0.5}
    volumes:
      - ./models:/app/models:ro
      - ./violations:/app/violations
      - ./test_videos:/videos:ro  # Mount video files directory
      # Uncomment below for webcam access (Linux/Mac only)
      # - /dev/video0:/dev/video0
    # Uncomment below for webcam access (Linux/Mac only)
    # devices:
    #   - /dev/video0:/dev/video0
    # privileged: true  # Required for device access
    restart: unless-stopped
    depends_on:
      - localstack
    networks:
      - safety-network

  # ============================================
  # OPTION 2: Multiple Camera Setup
  # Uncomment sections below for multi-camera deployment
  # ============================================
  
  # detection-camera1:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.detection
  #   container_name: safety-detection-camera1
  #   environment:
  #     - VIDEO_SOURCE=rtsp://admin:password@192.168.1.100:554/stream
  #     - CAMERA_ID=front_gate
  #     - SITE_LOCATION=Front Gate - Zone A
  #     - AWS_REGION=${AWS_REGION:-us-east-1}
  #     - SQS_QUEUE_URL=${SQS_QUEUE_URL}
  #     - S3_BUCKET_NAME=${S3_BUCKET_NAME:-safety-violations}
  #     - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
  #     - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
  #   volumes:
  #     - ./models:/app/models:ro
  #     - ./violations/camera1:/app/violations
  #   restart: unless-stopped
  #   depends_on:
  #     - localstack
  #   networks:
  #     - safety-network

  # detection-camera2:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.detection
  #   container_name: safety-detection-camera2
  #   environment:
  #     - VIDEO_SOURCE=rtsp://admin:password@192.168.1.101:554/stream
  #     - CAMERA_ID=loading_dock
  #     - SITE_LOCATION=Loading Dock - Zone B
  #     - AWS_REGION=${AWS_REGION:-us-east-1}
  #     - SQS_QUEUE_URL=${SQS_QUEUE_URL}
  #     - S3_BUCKET_NAME=${S3_BUCKET_NAME:-safety-violations}
  #     - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
  #     - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
  #   volumes:
  #     - ./models:/app/models:ro
  #     - ./violations/camera2:/app/violations
  #   restart: unless-stopped
  #   depends_on:
  #     - localstack
  #   networks:
  #     - safety-network

  # detection-camera3:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.detection
  #   container_name: safety-detection-camera3
  #   environment:
  #     - VIDEO_SOURCE=/videos/construction_site.mp4
  #     - CAMERA_ID=scaffolding
  #     - SITE_LOCATION=Scaffolding Area - Zone C
  #     - AWS_REGION=${AWS_REGION:-us-east-1}
  #     - SQS_QUEUE_URL=${SQS_QUEUE_URL}
  #     - S3_BUCKET_NAME=${S3_BUCKET_NAME:-safety-violations}
  #     - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
  #     - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
  #   volumes:
  #     - ./models:/app/models:ro
  #     - ./violations/camera3:/app/violations
  #     - ./test_videos:/videos:ro
  #   restart: unless-stopped
  #   depends_on:
  #     - localstack
  #   networks:
  #     - safety-network

  # ============================================
  # Agent Service (AI Reports)
  # ============================================
  agent-service:
    build:
      context: .
      dockerfile: Dockerfile.agent
    container_name: safety-agent
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - SQS_QUEUE_URL=${SQS_QUEUE_URL}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-safety-violations}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - DB_CONNECTION_STRING=${DB_CONNECTION_STRING}
      - EMAIL_ENABLED=${EMAIL_ENABLED:-true}
      - EMAIL_SENDER=${EMAIL_SENDER}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD}
      - EMAIL_RECIPIENTS=${EMAIL_RECIPIENTS}
      - SMTP_SERVER=${SMTP_SERVER:-smtp.gmail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2:-false}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY}
      - EMAIL_REPORT_MODE=${EMAIL_REPORT_MODE:-daily}
      - DAILY_REPORT_TIME=${DAILY_REPORT_TIME:-18:00}
    volumes:
      - ./reports:/app/reports
      - ./violations:/app/violations:ro
    restart: unless-stopped
    depends_on:
      - localstack
    networks:
      - safety-network

  # ============================================
  # Dashboard Service (Camera Management UI)
  # ============================================
  dashboard-service:
    build:
      context: .
      dockerfile: Dockerfile.dashboard
    container_name: safety-dashboard
    ports:
      - "5000:5000"  # Expose dashboard on port 5000
    environment:
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - SQS_QUEUE_URL=${SQS_QUEUE_URL}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-safety-violations}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - DB_CONNECTION_STRING=${DB_CONNECTION_STRING}
      - DASHBOARD_PORT=5000
      - FLASK_DEBUG=${FLASK_DEBUG:-false}
      - CAMERA_CONFIG=/app/cameras.json
    volumes:
      - ./cameras.json:/app/cameras.json:ro
      - ./reports:/app/reports:ro
      - ./violations:/app/violations:ro
    restart: unless-stopped
    depends_on:
      - localstack
    networks:
      - safety-network

  # ============================================
  # LocalStack (AWS Services Mock)
  # For local testing of SQS, S3, etc.
  # ============================================
  localstack:
    image: localstack/localstack:latest
    container_name: localstack-aws
    ports:
      - "4566:4566"  # LocalStack gateway
      - "4571:4571"  # S3
    environment:
      - SERVICES=sqs,s3
      - DEBUG=1
      - DATA_DIR=/tmp/localstack/data
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - "./localstack:/tmp/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      - safety-network

networks:
  safety-network:
    driver: bridge

volumes:
  localstack-data:
